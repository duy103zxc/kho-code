<!DOCTYPE HTML>
<html lang="vi" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Spring Security - Kho code cá»§a duykhanh471</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Trang chá»§ dá»± Ã¡n</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> HTML/CSS/JS</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../html-css/index.html"><strong aria-hidden="true">2.1.</strong> HTML/CSS</a></li><li class="chapter-item expanded "><a href="../js/index.html"><strong aria-hidden="true">2.2.</strong> JS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../js/co-ban.html"><strong aria-hidden="true">2.2.1.</strong> CÆ¡ báº£n</a></li><li class="chapter-item expanded "><a href="../js/array.html"><strong aria-hidden="true">2.2.2.</strong> Array</a></li><li class="chapter-item expanded "><a href="../js/ngay-gio.html"><strong aria-hidden="true">2.2.3.</strong> NgÃ y giá»</a></li><li class="chapter-item expanded "><a href="../js/string.html"><strong aria-hidden="true">2.2.4.</strong> String</a></li><li class="chapter-item expanded "><a href="../js/object.html"><strong aria-hidden="true">2.2.5.</strong> Object</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../java/index.html"><strong aria-hidden="true">3.</strong> Java</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../java/snippets/index.html"><strong aria-hidden="true">3.1.</strong> Kho snippets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../java/snippets/algorithms.html"><strong aria-hidden="true">3.1.1.</strong> Algorithms</a></li><li class="chapter-item expanded "><a href="../java/snippets/array.html"><strong aria-hidden="true">3.1.2.</strong> Array</a></li><li class="chapter-item expanded "><a href="../java/snippets/cls.html"><strong aria-hidden="true">3.1.3.</strong> CLS</a></li><li class="chapter-item expanded "><a href="../java/snippets/date.html"><strong aria-hidden="true">3.1.4.</strong> Date</a></li><li class="chapter-item expanded "><a href="../java/snippets/encoding.html"><strong aria-hidden="true">3.1.5.</strong> Encoding & Decoding</a></li><li class="chapter-item expanded "><a href="../java/snippets/file.html"><strong aria-hidden="true">3.1.6.</strong> File</a></li><li class="chapter-item expanded "><a href="../java/snippets/io.html"><strong aria-hidden="true">3.1.7.</strong> IO</a></li><li class="chapter-item expanded "><a href="../java/snippets/math.html"><strong aria-hidden="true">3.1.8.</strong> Math</a></li><li class="chapter-item expanded "><a href="../java/snippets/media.html"><strong aria-hidden="true">3.1.9.</strong> Media</a></li><li class="chapter-item expanded "><a href="../java/snippets/network.html"><strong aria-hidden="true">3.1.10.</strong> Network</a></li><li class="chapter-item expanded "><a href="../java/snippets/string.html"><strong aria-hidden="true">3.1.11.</strong> String</a></li><li class="chapter-item expanded "><a href="../java/snippets/thread.html"><strong aria-hidden="true">3.1.12.</strong> Thread</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../spring-boot/index.html"><strong aria-hidden="true">4.</strong> Spring Boot</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../spring-boot/core.html"><strong aria-hidden="true">4.1.</strong> Core</a></li><li class="chapter-item expanded "><a href="../spring-boot/spring-boot.html"><strong aria-hidden="true">4.2.</strong> Spring Boot</a></li><li class="chapter-item expanded "><a href="../spring-boot/jpa.html"><strong aria-hidden="true">4.3.</strong> Jpa</a></li><li class="chapter-item expanded "><a href="../spring-boot/ss.html" class="active"><strong aria-hidden="true">4.4.</strong> Spring Security</a></li><li class="chapter-item expanded "><a href="../spring-boot/redis.html"><strong aria-hidden="true">4.5.</strong> Redis</a></li></ol></li><li class="chapter-item expanded "><a href="../rust/index.html"><strong aria-hidden="true">5.</strong> Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rust/thuat-toan.html"><strong aria-hidden="true">5.1.</strong> Thuáº­t toÃ¡n</a></li><li class="chapter-item expanded "><a href="../rust/command-line.html"><strong aria-hidden="true">5.2.</strong> CLI</a></li><li class="chapter-item expanded "><a href="../rust/he-thong.html"><strong aria-hidden="true">5.3.</strong> System</a></li><li class="chapter-item expanded "><a href="../rust/internet.html"><strong aria-hidden="true">5.4.</strong> Internet</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.5.</strong> Tá»‡p</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../rust/tep/epub.html"><strong aria-hidden="true">5.5.1.</strong> EPUB</a></li><li class="chapter-item expanded "><a href="../rust/tep/git.html"><strong aria-hidden="true">5.5.2.</strong> Git</a></li><li class="chapter-item expanded "><a href="../rust/tep/html.html"><strong aria-hidden="true">5.5.3.</strong> HTML</a></li><li class="chapter-item expanded "><a href="../rust/tep/rss.html"><strong aria-hidden="true">5.5.4.</strong> RSS</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../react/index.html"><strong aria-hidden="true">6.</strong> React</a></li><li class="chapter-item expanded "><a href="../react-native/index.html"><strong aria-hidden="true">7.</strong> React Native</a></li><li class="chapter-item expanded "><a href="../bash/tong-hop.html"><strong aria-hidden="true">8.</strong> Bash</a></li><li class="chapter-item expanded "><a href="../regex/tong-hop.html"><strong aria-hidden="true">9.</strong> Regex</a></li><li class="chapter-item expanded "><a href="../khac/yt-dlp.html"><strong aria-hidden="true">10.</strong> yt-dlp</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Kho code cá»§a duykhanh471</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ss-hÆ°á»›ng-dáº«n-spring-security-cÆ¡-báº£n-dá»…-hiá»ƒu"><a class="header" href="#ss-hÆ°á»›ng-dáº«n-spring-security-cÆ¡-báº£n-dá»…-hiá»ƒu">[SS] HÆ°á»›ng dáº«n Spring Security cÆ¡ báº£n, dá»… hiá»ƒu</a></h1>
<ul>
<li>Giá»›i thiá»‡u</li>
<li>CÃ i Ä‘áº·t</li>
<li>Implement</li>
<li>KÃ­ch hoáº¡t tÃ­nh nÄƒng WebSecurity</li>
<li>Táº¡o tÃ i khoáº£n user</li>
<li>PhÃ¢n quyá»n truy cáº­p</li>
<li>ThÃªm controller.</li>
<li>Cháº¡y thá»­</li>
<li>Káº¿t</li>
</ul>
<h3 id="giá»›i-thiá»‡u"><a class="header" href="#giá»›i-thiá»‡u"><strong>Giá»›i thiá»‡u</strong></a></h3>
<p><strong>Spring Security</strong>Â lÃ  má»™t trong nhá»¯ng core feature quan trá»ng cá»§a Spring Framework, nÃ³ giÃºp chÃºng ta phÃ¢n quyá»n vÃ  xÃ¡c thá»±c ngÆ°á»i dÃ¹ng trÆ°á»›c khi cho phÃ©p há» truy cáº­p vÃ o cÃ¡c tÃ i nguyÃªn cá»§a chÃºng ta.</p>
<p>Trong bÃ i hÆ°á»›ng dáº«n nÃ y, tÃ´i sáº½ hÆ°á»›ng dáº«n cÃ¡c báº¡n cÃ¡ch implementÂ <strong>Spring Security</strong>Â má»™t cÃ¡ch cÆ¡ báº£n nháº¥t, Ä‘Æ¡n giáº£n nháº¥t, chÃºng ta sáº½ nÃ¢ng cao dáº§n á»Ÿ cÃ¡c bÃ i sau.</p>
<h3 id="cÃ i-Ä‘áº·t"><a class="header" href="#cÃ i-Ä‘áº·t"><strong>CÃ i Ä‘áº·t</strong></a></h3>
<p>ChÃºng ta cÃ i thÆ° viá»‡n qua maven, cÃ¡c dependencies bao gá»“m:</p>
<p><em>pom.xml</em></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-example&lt;/artifactId&gt;
    &lt;version&gt;0.1.0&lt;/version&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;
    &lt;/parent&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;
            &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre>
<p>ThÆ° má»¥c code gá»“m cÃ³:</p>
<p>!image</p>
<h3 id="implement"><a class="header" href="#implement"><strong>Implement</strong></a></h3>
<h3 id="kÃ­ch-hoáº¡t-tÃ­nh-nÄƒng-websecurity"><a class="header" href="#kÃ­ch-hoáº¡t-tÃ­nh-nÄƒng-websecurity"><strong>KÃ­ch hoáº¡t tÃ­nh nÄƒng WebSecurity</strong></a></h3>
<p>TrÆ°á»›c tiÃªn, Ä‘á»ƒ kÃ­ch hoáº¡t tÃ­nh nÄƒng Spring Security trÃªn á»©ng dá»¥ng Web cá»§a mÃ¬nh, cÃ¡c báº¡n cáº§n gáº¯n annotationÂ <code>@EnableWebSecurity</code>Â trÃªn má»™t bean báº¥t ká»³ cá»§a mÃ¬nh.</p>
<p>á» Ä‘Ã¢y, tÃ´i táº¡o ra má»™t classÂ <code>WebSecurityConfig</code>Â Ä‘á»ƒ lÃ  nÆ¡i táº­p trung cÃ¡c xá»­ lÃ½ cÃ¡c thÃ´ng tin liÃªn quan tá»›i security.</p>
<pre><code>@EnableWebSecurity
public class WebSecurityConfig {
    // ...
}
</code></pre>
<h3 id="táº¡o-tÃ i-khoáº£n-user"><a class="header" href="#táº¡o-tÃ i-khoáº£n-user"><strong>Táº¡o tÃ i khoáº£n user</strong></a></h3>
<p>ThÃ´ng thÆ°á»ng, tÃ i khoáº£n user cá»§a ngÆ°á»i dÃ¹ng sáº½ Ä‘Æ°á»£c lÆ°u trong csdl vÃ  mÃ£ hÃ³a. Tuy nhiÃªn, trong vÃ­ dá»¥ cá»±c kÃ¬ basic nÃ y, tÃ´i sáº½ lÆ°u má»™t tÃ i khoáº£n ngÆ°á»i dÃ¹ng trong chÃ­nh bá»™ nhá»› chÆ°Æ¡ng trÃ¬nh.</p>
<p>CÃ¡ch nÃ y chá»‰ Ä‘á»ƒ demo thÃ´i nhÃ©, vÃ¬ nÃ³ dá»¯ liá»‡u sáº½ bá»‹ máº¥t khi táº¯t á»©ng dá»¥ng, chÃºng ta sáº½ tÃ¬m hiá»ƒu cÃ¡ch xÃ¡c thá»±c báº±ng csdl á»Ÿ bÃ i sau.</p>
<pre><code>@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Bean
    @Override
    public UserDetailsService userDetailsService() {
        // Táº¡o ra user trong bá»™ nhá»›
        // lÆ°u Ã½, chá»‰ sá»­ dá»¥ng cÃ¡ch nÃ y Ä‘á»ƒ minh há»a
        // CÃ²n thá»±c táº¿ chÃºng ta sáº½ kiá»ƒm tra user trong csdl
        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
        manager.createUser(
                User.withDefaultPasswordEncoder() // Sá»­ dá»¥ng mÃ£ hÃ³a password Ä‘Æ¡n giáº£n
                    .username(&quot;loda&quot;)
                    .password(&quot;loda&quot;)
                    .roles(&quot;USER&quot;) // phÃ¢n quyá»n lÃ  ngÆ°á»i dÃ¹ng.
                    .build()
        );
        return manager;
    }
}
</code></pre>
<p><code>WebSecurityConfigurerAdapter</code>Â lÃ  má»™t interface tiá»‡n Ã­ch cá»§a Spring Security giÃºp chÃºng ta cÃ i Ä‘áº·t cÃ¡c thÃ´ng tin dá»… dÃ ng hÆ¡n.</p>
<p><em>Method</em><code>userDetailsService()</code>Â cÃ³ tÃ¡c dá»¥ng cung cáº¥p thÃ´ng tin user cho Spring Security, chÃºng taÂ <em>Override</em>Â láº¡i method nÃ y vÃ  cung cáº¥p cho nÃ³ má»™tÂ <code>User</code>Â lÃ Â <code>loda</code>.</p>
<h3 id="phÃ¢n-quyá»n-truy-cáº­p"><a class="header" href="#phÃ¢n-quyá»n-truy-cáº­p"><strong>PhÃ¢n quyá»n truy cáº­p</strong></a></h3>
<p>Khi Ä‘Ã£ cÃ³Â <code>User</code>, chÃºng ta sáº½ cáº§n phÃ¢n quyá»n xem má»™tÂ <code>User</code>Â sáº½ Ä‘Æ°á»£c phÃ©p truy cáº­p vÃ o nhá»¯ng tÃ i nguyÃªn nÃ o.</p>
<p>LÃºc nÃ y, váº«n á»Ÿ trongÂ <code>WebSecurityConfigurerAdapter</code>, chÃºng ta override láº¡i methodÂ <code>protected void configure(HttpSecurity http)</code>Â Ä‘á»ƒ thá»±c hiá»‡n viá»‡c phÃ¢n quyá»n.</p>
<pre><code>import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.provisioning.InMemoryUserDetailsManager;

@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Bean
    @Override
    public UserDetailsService userDetailsService() {
        // Táº¡o ra user trong bá»™ nhá»›
        // lÆ°u Ã½, chá»‰ sá»­ dá»¥ng cÃ¡ch nÃ y Ä‘á»ƒ minh há»a
        // CÃ²n thá»±c táº¿ chÃºng ta sáº½ kiá»ƒm tra user trong csdl
        InMemoryUserDetailsManager manager = new InMemoryUserDetailsManager();
        manager.createUser(
                User.withDefaultPasswordEncoder() // Sá»­ dá»¥ng mÃ£ hÃ³a password Ä‘Æ¡n giáº£n
                    .username(&quot;loda&quot;)
                    .password(&quot;loda&quot;)
                    .roles(&quot;USER&quot;) // phÃ¢n quyá»n lÃ  ngÆ°á»i dÃ¹ng.
                    .build()
        );
        return manager;
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                    .antMatchers(&quot;/&quot;, &quot;/home&quot;).permitAll() // Cho phÃ©p táº¥t cáº£ má»i ngÆ°á»i truy cáº­p vÃ o 2 Ä‘á»‹a chá»‰ nÃ y
                    .anyRequest().authenticated() // Táº¥t cáº£ cÃ¡c request khÃ¡c Ä‘á»u cáº§n pháº£i xÃ¡c thá»±c má»›i Ä‘Æ°á»£c truy cáº­p
                    .and()
                .formLogin() // Cho phÃ©p ngÆ°á»i dÃ¹ng xÃ¡c thá»±c báº±ng form login
                    .defaultSuccessUrl(&quot;/hello&quot;)
                    .permitAll() // Táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c truy cáº­p vÃ o Ä‘á»‹a chá»‰ nÃ y
                    .and()
                .logout() // Cho phÃ©p logout
                    .permitAll();
    }
}
</code></pre>
<p><code>HttpSecurity</code>Â lÃ  Ä‘á»‘i tÆ°á»£ng chÃ­nh cá»§a Spring Security, cho phÃ©p chÃºng ta cáº¥u hÃ¬nh má»i thá»© cáº§n báº£o máº­t, vÃ  nÃ³ Ä‘Æ°á»£c xÃ¢y dá»±ng dÆ°á»›i design pattern giá»‘ng vá»›iÂ <code>Builder Pattern</code>, nÃªn má»i cÃ i Ä‘áº·t cÃ³ thá»ƒ viáº¿t liÃªn tá»¥c thÃ´ng qua toÃ¡n tá»­Â <code>.</code></p>
<p>á» vÃ­ dá»¥ trÃªn, nhá»¯ng gÃ¬ chÃºng ta muá»‘n cho phÃ©p, chÃºng ta sáº½ xÃ i methodÂ <code>.permit()</code>, cÃ²n nhá»¯ng gÃ¬ cáº¥m hoáº·c yÃªu cáº§u xÃ¡c thá»±c sáº½ dÃ¹ngÂ <code>.authenticated()</code></p>
<p>Khi gá»iÂ <code>.formLogin()</code>Â thÃ¬ chÃºng ta cáº¥u hÃ¬nh cho phÃ©p ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p, thÃ´ng qua Ä‘á»‹a chá»‰ máº·c Ä‘á»‹nhÂ <code>/login</code>Â do Spring Security tá»± táº¡o ra (CÃ¡i nÃ y cÃ³ thá»ƒ custom theo Ã½ mÃ¬nh Ä‘Æ°á»£c, nhÆ°ng chÃºng ta sáº½ tiáº¿p cáº­n á»Ÿ bÃ i sau).</p>
<p>TÆ°Æ¡ng tá»±Â <code>.logout()</code>Â cho phÃ©p ngÆ°á»i dÃ¹ng logout, Náº¿u khÃ´ng nÃ³i gÃ¬ thÃªm, Spring Security sáº½ máº·c Ä‘á»‹nh tá»± táº¡o ra má»™t trang logout vá»›i Ä‘á»‹a chá»‰Â <code>/logout</code>.</p>
<h3 id="thÃªm-controller"><a class="header" href="#thÃªm-controller"><strong>ThÃªm controller.</strong></a></h3>
<p>ChÃºng ta táº¡o ra trang web cá»§a mÃ¬nh gá»“m cÃ³ trangÂ <code>homepage</code>Â vÃ  trangÂ <code>hello</code>.</p>
<ul>
<li>TrangÂ <code>homepage</code>Â thÃ¬ ai cÅ©ng truy cáº­p Ä‘Æ°á»£c.</li>
<li>TrangÂ <code>hello</code>Â thÃ¬ pháº£i xÃ¡c thá»±c má»›i Ä‘Æ°á»£c truy cáº­p.</li>
</ul>
<p>CÃ¡c Ä‘á»‹a chá»‰Â <code>/login</code>Â vÃ Â <code>/logout</code>Â thÃ¬ khÃ´ng cáº§n táº¡o, Spring Security Ä‘Ã£ táº¡o sáºµn rá»“i, chÃºng ta dÃ¹ng láº¡i luÃ´n.</p>
<pre><code>import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class WebController {

    @GetMapping(value = {&quot;/&quot;, &quot;/home&quot;})
    public String homepage() {
        return &quot;home&quot;; // Tráº£ vá» home.html
    }

    @GetMapping(&quot;/hello&quot;)
    public String hello() {
        return &quot;hello&quot;; // Tráº£ vá» hello.html
    }

}
</code></pre>
<p>Ukie, Ä‘Æ¡n giáº£n váº­y thÃ´i, bÃ¢y giá» cáº§n táº¡o ra cÃ¡c trangÂ <code>home.html</code>Â vÃ Â <code>hello.html</code>.</p>
<p>VÃ¬ á»Ÿ trong fileÂ <em>pom.xml</em>Â chÃºng ta Ä‘Ã£ cÃ i thÆ° viá»‡nÂ <code>thymeleaf</code>. NÃªn nÃ³ sáº½ tá»± Ä‘á»™ng mapping tÃªn tÆ°Æ¡ng á»©ng trongÂ <code>Controller</code>Â tráº£ vá» vá»›i cÃ¡c file á»Ÿ bÃªn trong thÆ° má»¥cÂ <code>resources/templates/</code></p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p><em>hello.html</em></p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;
&lt;head&gt;
  &lt;title&gt;Hello&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Chá»‰ nhá»¯ng ai Ä‘Äƒng nháº­p má»›i truy cáº­p Ä‘Æ°á»£c trang nÃ y!&lt;/h1&gt;

&lt;form th:action=&quot;@{/logout}&quot; method=&quot;post&quot;&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Sign Out&quot;/&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>CÃº phÃ¡pÂ <code>th:action=&quot;@{/logout}&quot;</code>Â lÃ  cá»§a thymeleaf, cÃ³ tÃ¡c dá»¥ng request tá»›i Ä‘á»‹a chá»‰Â <code>/logout</code></p>
<p><em>home.html</em></p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;
&lt;head&gt;
  &lt;title&gt;Spring Security Example&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome!&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;/login&quot;&gt;login&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Click &lt;a href=&quot;https://loda.me&quot;&gt;here&lt;/a&gt; to see a loda homepage.&lt;/p&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="cháº¡y-thá»­"><a class="header" href="#cháº¡y-thá»­"><strong>Cháº¡y thá»­</strong></a></h3>
<p>Cháº¡y á»©ng dá»¥ng báº±ng cÃ¡ch implementÂ <code>@SpringBootApplication</code></p>
<pre><code>import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class App {
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }
}
</code></pre>
<p>Khi cháº¡y xong, truy cáº­p vÃ o Ä‘Æ°á»ng dáº«nÂ <code>http://localhost:8080/home</code>Â Ä‘á»ƒ vÃ o trang chá»§.</p>
<p>!image</p>
<p>Khi chÆ°a Ä‘Äƒng nháº­p, chÃºng ta truy cáº­p vÃ o Ä‘Æ°á»ng dáº«nÂ <code>/hello</code>. ThÃ¬ nÃ³ sáº½ tá»± redirect sang trangÂ <code>/login</code>.</p>
<p>!image</p>
<p>Khi Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng, chÃºng ta sáº½ cÃ³ thá»ƒ vÃ o trangÂ <code>/hello</code>Â nhÆ° bÃ¬nh thÆ°á»ng.</p>
<p>!image</p>
<p>Khi click vÃ oÂ <code>Sign Out</code>Â thÃ¬ sáº½ Ä‘Äƒng xuáº¥t.</p>
<p>!image</p>
<h3 id="káº¿t"><a class="header" href="#káº¿t"><strong>Káº¿t</strong></a></h3>
<p>Trong bÃ i nÃ y, tÃ´i Ä‘Ã£ giá»›i thiá»‡u vá»›i cÃ¡c báº¡n vá»Â <strong>Spring Security</strong>Â Ä‘á»“ng thá»i giá»›i thiá»‡u cÃ¡c khÃ¡i niá»‡m cÆ¡ báº£n vá» User vÃ  phÃ¢n quyá»n. á» cÃ¡c bÃ i nÃ¢ng cao sau, tÃ´i sáº½ giá»›i thiá»‡u thÃªm vá»›i cÃ¡c báº¡n vá» cÃ¡ch xÃ¡c thá»±c ngÆ°á»i dÃ¹ng trong csdl vÃ  xÃ¡c thá»±c báº±ngÂ <code>OAuth 2.0</code></p>
<p>BÃ i viáº¿t liÃªn quan:</p>
<ol>
<li>[â›³SS] HÆ°á»›ng dáº«n Spring Security + Jpa Hibernate</li>
</ol>
<p>ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i <strong>GitHub</strong></p>
<p>ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series <strong>LÃ m chá»§ Spring Boot â€“ Zero to Hero</strong></p>
<h1 id="ss-hÆ°á»›ng-dáº«n-spring-security--jpa-hibernate"><a class="header" href="#ss-hÆ°á»›ng-dáº«n-spring-security--jpa-hibernate">[SS] HÆ°á»›ng dáº«n Spring Security + Jpa Hibernate</a></h1>
<ul>
<li>Giá»›i thiá»‡u</li>
<li>CÃ i Ä‘áº·t</li>
<li>Implement</li>
<li>Táº¡o User</li>
<li>Tham chiáº¿u User vá»›i UserDetails</li>
<li>Cáº¥u hÃ¬nh vÃ  phÃ¢n quyá»n</li>
<li>Táº¡o Controller vÃ  webpage</li>
<li>Táº¡o thÃ´ng tin User trong database</li>
<li>#Â Cháº¡y thá»­</li>
<li>Káº¿t</li>
</ul>
<h3 id="giá»›i-thiá»‡u-1"><a class="header" href="#giá»›i-thiá»‡u-1"><strong>Giá»›i thiá»‡u</strong></a></h3>
<p>TrongÂ bÃ i trÆ°á»›c, tÃ´i Ä‘Ã£ hÆ°á»›ng dáº«n vá»›i cÃ¡c báº¡n vá» cÃ¡ch Ä‘á»ƒ sá»­ dá»¥ngÂ <strong>Spring Security</strong>Â cÆ¡ báº£n, cÃ¡ch kÃ­ch hoáº¡t, táº¡o user vÃ  phÃ¢n quyá»n.</p>
<p>Trong bÃ i nÃ y, chÃºng sáº½ tÃ¬m hiá»ƒu cÃ¡ch Ä‘á»ƒ kiá»ƒm tra má»™tÂ <code>User</code>Â á»Ÿ bÃªn trong csdl.</p>
<p>Trong bÃ i viáº¿t giáº£ Ä‘á»‹nh báº¡n Ä‘Ã£ cÃ³ cÃ¡c kiáº¿n thá»©c sau:</p>
<ol>
<li>Hibernate</li>
<li>Lombok</li>
<li>Spring Security CÆ¡ báº£n</li>
</ol>
<h3 id="cÃ i-Ä‘áº·t-1"><a class="header" href="#cÃ i-Ä‘áº·t-1"><strong>CÃ i Ä‘áº·t</strong></a></h3>
<p>ChÃºng ta sá»­ dá»¥ngÂ <strong>Maven</strong>, CÃ i Ä‘áº·t fileÂ <em>pom.xml</em>Â cá»§a báº¡n nhÆ° sau.</p>
<p>KhÃ¡c vá»›i project trÆ°á»›c Ä‘Ã³, láº§n nÃ y chÃºng ta sá»­ dá»¥ng thÃªm databaseÂ <code>com.h2database</code>. ÄÃ¢y lÃ  má»™tÂ <em>in memory database</em>. Äáº¡i khÃ¡i lÃ  má»i thá»© báº¡n lÆ°u trÃªn database chá»‰ tá»“n táº¡i trong bá»™ nhá»›, khi táº¯t á»©ng dá»¥ng, database sáº½ máº¥t sáº¡ch, thÃ­ch há»£p cho viá»‡c demo.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-hibernate&lt;/artifactId&gt;
    &lt;version&gt;0.1.0&lt;/version&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;
    &lt;/parent&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre>
<p>ThÆ° má»¥c code gá»“m cÃ³:</p>
<p>!image</p>
<h3 id="implement-1"><a class="header" href="#implement-1"><strong>Implement</strong></a></h3>
<h3 id="táº¡o-user"><a class="header" href="#táº¡o-user"><strong>Táº¡o User</strong></a></h3>
<p>Táº¡o ra classÂ <code>User</code>Â tham chiáº¿u vá»›i database.</p>
<pre><code>import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Table;

import lombok.Data;

@Entity
@Table(name = &quot;user&quot;)
@Data // lombok
public class User {
    @Id
    @GeneratedValue
    private Long id;

    @Column(nullable = false, unique = true)
    private String username;
    private String password;
}
</code></pre>
<p>Táº¡oÂ <code>UserRepository</code>Â káº¿ thá»«aÂ <code>JpaRepository</code>Â Ä‘á»ƒ truy xuáº¥t thÃ´ng tin tá»« database.</p>
<pre><code>import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository&lt;User, Long&gt; {
    User findByUsername(String username);
}
</code></pre>
<h3 id="tham-chiáº¿u-user-vá»›i-userdetails"><a class="header" href="#tham-chiáº¿u-user-vá»›i-userdetails"><strong>Tham chiáº¿u User vá»›i UserDetails</strong></a></h3>
<p>Máº·c Ä‘á»‹nhÂ <strong>Spring Security</strong>Â sá»­ dá»¥ng má»™t Ä‘á»‘i tÆ°á»£ngÂ <code>UserDetails</code>Â Ä‘á»ƒ chá»©a toÃ n bá»™ thÃ´ng tin vá» ngÆ°á»i dÃ¹ng. VÃ¬ váº­y, chÃºng ta cáº§n táº¡o ra má»™t class má»›i giÃºp chuyá»ƒn cÃ¡c thÃ´ng tin cá»§aÂ <code>User</code>Â thÃ nhÂ <code>UserDetails</code></p>
<p><em>CustomUserDetails.java</em></p>
<pre><code>import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class CustomUserDetails implements UserDetails {
    User user;

    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
        // Máº·c Ä‘á»‹nh mÃ¬nh sáº½ Ä‘á»ƒ táº¥t cáº£ lÃ  ROLE_USER. Äá»ƒ demo cho Ä‘Æ¡n giáº£n.
        return Collections.singleton(new SimpleGrantedAuthority(&quot;ROLE_USER&quot;));
    }

    @Override
    public String getPassword() {
        return user.getPassword();
    }

    @Override
    public String getUsername() {
        return user.getUsername();
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}
</code></pre>
<p>Khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p thÃ¬Â <strong>Spring Security</strong>Â sáº½ cáº§n láº¥y cÃ¡c thÃ´ng tinÂ <code>UserDetails</code>Â hiá»‡n cÃ³ Ä‘á»ƒ kiá»ƒm tra. VÃ¬ váº­y, báº¡n cáº§n táº¡o ra má»™t class káº¿ thá»«a lá»›pÂ <code>UserDetailsService</code>Â mÃ Â <strong>Spring Security</strong>Â cung cáº¥p Ä‘á»ƒ lÃ m nhiá»‡m vá»¥ nÃ y.</p>
<p><em>UserService.java</em></p>
<pre><code>import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
public class UserService implements UserDetailsService {

    @Autowired
    private UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) {
        // Kiá»ƒm tra xem user cÃ³ tá»“n táº¡i trong database khÃ´ng?
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException(username);
        }
        return new CustomUserDetails(user);
    }

}
</code></pre>
<h3 id="cáº¥u-hÃ¬nh-vÃ -phÃ¢n-quyá»n"><a class="header" href="#cáº¥u-hÃ¬nh-vÃ -phÃ¢n-quyá»n"><strong>Cáº¥u hÃ¬nh vÃ  phÃ¢n quyá»n</strong></a></h3>
<p>Giá»‘ng vá»›iÂ bÃ i trÆ°á»›c, chÃºng ta cáº§n kÃ­ch hoáº¡tÂ <strong>Spring Security</strong>Â vÃ  phÃ¢n quyá»n ngÆ°á»i dÃ¹ng.</p>
<pre><code>import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;

import me.loda.spring.springsecurityhibernate.user.UserService;

@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Autowired
    UserService userService;

    @Bean
    public PasswordEncoder passwordEncoder() {
        // Password encoder, Ä‘á»ƒ Spring Security sá»­ dá»¥ng mÃ£ hÃ³a máº­t kháº©u ngÆ°á»i dÃ¹ng
        return new BCryptPasswordEncoder();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth)
            throws Exception {
        auth.userDetailsService(userService) // Cung cÃ¡p userservice cho spring security
            .passwordEncoder(passwordEncoder()); // cung cáº¥p password encoder
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .authorizeRequests()
                .antMatchers(&quot;/&quot;, &quot;/home&quot;).permitAll() // Cho phÃ©p táº¥t cáº£ má»i ngÆ°á»i truy cáº­p vÃ o 2 Ä‘á»‹a chá»‰ nÃ y
                .anyRequest().authenticated() // Táº¥t cáº£ cÃ¡c request khÃ¡c Ä‘á»u cáº§n pháº£i xÃ¡c thá»±c má»›i Ä‘Æ°á»£c truy cáº­p
                .and()
                .formLogin() // Cho phÃ©p ngÆ°á»i dÃ¹ng xÃ¡c thá»±c báº±ng form login
                .defaultSuccessUrl(&quot;/hello&quot;)
                .permitAll() // Táº¥t cáº£ Ä‘á»u Ä‘Æ°á»£c truy cáº­p vÃ o Ä‘á»‹a chá»‰ nÃ y
                .and()
                .logout() // Cho phÃ©p logout
                .permitAll();
    }
}
</code></pre>
<h3 id="táº¡o-controller-vÃ -webpage"><a class="header" href="#táº¡o-controller-vÃ -webpage"><strong>Táº¡o Controller vÃ  webpage</strong></a></h3>
<p>ChÃºng ta táº¡o ra trang web cá»§a mÃ¬nh gá»“m cÃ³ trangÂ <code>homepage</code>Â vÃ  trangÂ <code>hello</code>.</p>
<ul>
<li>TrangÂ <code>homepage</code>Â thÃ¬ ai cÅ©ng truy cáº­p Ä‘Æ°á»£c.</li>
<li>TrangÂ <code>hello</code>Â thÃ¬ pháº£i xÃ¡c thá»±c má»›i Ä‘Æ°á»£c truy cáº­p.</li>
</ul>
<p>Máº·c Ä‘á»‹nhÂ <code>/login</code>Â vÃ Â <code>/logout</code><strong>Spring Security</strong>Â Ä‘Ã£ táº¡o cho chÃºng ta rá»“i.</p>
<pre><code>@Controller
public class WebController {

    @GetMapping(value = {&quot;/&quot;, &quot;/home&quot;})
    public String homepage() {
        return &quot;home&quot;;
    }

    @GetMapping(&quot;/hello&quot;)
    public String hello() {
        return &quot;hello&quot;;
    }

}
</code></pre>
<p><em>hello.html</em></p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;
&lt;head&gt;
  &lt;title&gt;Hello&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Chá»‰ nhá»¯ng ai Ä‘Äƒng nháº­p má»›i truy cáº­p Ä‘Æ°á»£c trang nÃ y!&lt;/h1&gt;

&lt;form th:action=&quot;@{/logout}&quot; method=&quot;post&quot;&gt;
  &lt;input type=&quot;submit&quot; value=&quot;Sign Out&quot;/&gt;
&lt;/form&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<p>CÃº phÃ¡pÂ <code>th:action=&quot;@{/logout}&quot;</code>Â lÃ  cá»§a thymeleaf, cÃ³ tÃ¡c dá»¥ng request tá»›i Ä‘á»‹a chá»‰Â <code>/logout</code></p>
<p><em>home.html</em></p>
<pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot; xmlns:th=&quot;http://www.thymeleaf.org&quot;&gt;
&lt;head&gt;
  &lt;title&gt;Spring Security Example&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome!&lt;/h1&gt;

&lt;p&gt;&lt;a href=&quot;/login&quot;&gt;login&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Click &lt;a href=&quot;https://loda.me&quot;&gt;here&lt;/a&gt; to see a loda homepage.&lt;/p&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h3 id="táº¡o-thÃ´ng-tin-user-trong-database"><a class="header" href="#táº¡o-thÃ´ng-tin-user-trong-database"><strong>Táº¡o thÃ´ng tin User trong database</strong></a></h3>
<p>TrÆ°á»›c háº¿t báº¡n cáº§n cáº¥u hÃ¬nh cho hibernate káº¿t tá»›i tá»›i h2 database trong fileÂ <code>resources/appication.properties</code></p>
<pre><code>spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
# Enabling H2 Console
spring.h2.console.enabled=true
</code></pre>
<p>Äá»ƒ phá»¥c vá»¥ demo, má»—i khi cháº¡y chÆ°Æ¡ng trÃ¬nh, chÃºng ta cáº§n insert má»™tÂ <code>User</code>Â vÃ o database.</p>
<p>CÃ³ thá»ƒ lÃ m viá»‡c nÃ y báº±ng cÃ¡ch sá»­ dá»¥ngÂ <code>CommandLineRunner</code>. Má»™t interface cá»§a Spring cung cáº¥p, cÃ³ tÃ¡c dá»¥ng thá»±c hiá»‡n má»™t nhiá»‡m vá»¥ khi Spring khá»Ÿi cháº¡y láº§n Ä‘áº§u.</p>
<pre><code>@SpringBootApplication
public class App implements CommandLineRunner {
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }

    @Autowired
    UserRepository userRepository;
    @Autowired
    PasswordEncoder passwordEncoder;

    @Override
    public void run(String... args) throws Exception {
        // Khi chÆ°Æ¡ng trÃ¬nh cháº¡y
        // Insert vÃ o csdl má»™t user.
        User user = new User();
        user.setUsername(&quot;loda&quot;);
        user.setPassword(passwordEncoder.encode(&quot;loda&quot;));
        userRepository.save(user);
        System.out.println(user);
    }
}
</code></pre>
<h3 id="cháº¡y-thá»­-1"><a class="header" href="#cháº¡y-thá»­-1">**#**<strong>Cháº¡y thá»­</strong></a></h3>
<p>Truy cáº­p vÃ o Ä‘Æ°á»ng dáº«nÂ <code>http://localhost:8080/home</code>Â Ä‘á»ƒ vÃ o trang chá»§.</p>
<p>!image</p>
<p>Khi chÆ°a Ä‘Äƒng nháº­p, chÃºng ta truy cáº­p vÃ o Ä‘Æ°á»ng dáº«nÂ <code>/hello</code>. ThÃ¬ nÃ³ sáº½ tá»± redirect sang trangÂ <code>/login</code>.</p>
<p>!image</p>
<p>Khi Ä‘Ã£ Ä‘Äƒng nháº­p thÃ nh cÃ´ng, chÃºng ta sáº½ cÃ³ thá»ƒ vÃ o trangÂ <code>/hello</code>Â nhÆ° bÃ¬nh thÆ°á»ng.</p>
<p>!image</p>
<p>Khi click vÃ oÂ <code>Sign Out</code>Â thÃ¬ sáº½ Ä‘Äƒng xuáº¥t.</p>
<p>!image</p>
<h3 id="káº¿t-1"><a class="header" href="#káº¿t-1"><strong>Káº¿t</strong></a></h3>
<p>Trong bÃ i nÃ y, chÃºng ta Ä‘Ã£ tÃ¬m hiá»ƒu cÃ¡ch sá»­ dá»¥ng Spring Security káº¿t há»£p vá»›i Hibernate Ä‘á»ƒ cÃ³ thá»ƒ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng trong cÆ¡ sá»Ÿ dá»¯ liá»‡u. ChÃºng ta sáº½ tÃ¬m hiá»ƒu cÃ¡c cÃ¡ch xÃ¡c thá»±cÂ <code>OAuth 2.0</code>Â á»Ÿ cÃ¡c bÃ i sau.</p>
<p>ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i <strong>GitHub</strong></p>
<p>ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series <strong>LÃ m chá»§ Spring Boot â€“ Zero to Hero</strong></p>
<h1 id="ss-hÆ°á»›ng-dáº«n-spring-security--jwt-json-web-token--hibernate"><a class="header" href="#ss-hÆ°á»›ng-dáº«n-spring-security--jwt-json-web-token--hibernate">[SS] HÆ°á»›ng dáº«n Spring Security + JWT (Json Web Token) + Hibernate</a></h1>
<ul>
<li>Giá»›i thiá»‡u</li>
<li>CÃ i Ä‘áº·t</li>
<li>Implement</li>
<li>Táº¡o User</li>
<li>Tham chiáº¿u User vá»›i UserDetails</li>
<li>JWT</li>
<li>Cáº¥u hÃ¬nh vÃ  phÃ¢n quyá»n</li>
<li>Táº¡o Controller</li>
<li>Táº¡o thÃ´ng tin User trong database</li>
<li>Cháº¡y thá»­</li>
<li>Káº¿t</li>
</ul>
<h3 id="giá»›i-thiá»‡u-2"><a class="header" href="#giá»›i-thiá»‡u-2"><strong>Giá»›i thiá»‡u</strong></a></h3>
<p>Xin chÃ o cÃ¡c báº¡n, Trong hai bÃ i trÆ°á»›c tÃ´i Ä‘Ã£ giá»›i thiá»‡u cÃ¡ch sá»­ dá»¥ngÂ <strong>Spring Security</strong>Â vÃ  káº¿t ná»‘i vá»›i database Ä‘á»ƒ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng.</p>
<ol>
<li>Spring Security CÆ¡ báº£n</li>
<li>Spring Security + Hibernate</li>
</ol>
<p>Trong bÃ i hÃ´m nay chÃºng ta sáº½ tÃ¬m hiá»ƒu má»™t pháº§n cá»±c ká»³ quan trá»ng trong cÃ¡c há»‡ thá»‘ng báº£o máº­t ngÃ y nay, Ä‘Ã³ lÃ Â <strong>JWT</strong>.</p>
<p><strong>JWT (Json web Token)</strong>Â lÃ  má»™t chuá»—i mÃ£ hÃ³a Ä‘Æ°á»£c gá»­i kÃ¨m trong Header cá»§a client request cÃ³ tÃ¡c dá»¥ng giÃºp phÃ­a server xÃ¡c thá»±c request ngÆ°á»i dÃ¹ng cÃ³ há»£p lá»‡ hay khÃ´ng. ÄÆ°á»£c sá»­ dá»¥ng phá»• biáº¿n trong cÃ¡c há»‡ thá»‘ng API ngÃ y nay.</p>
<p>!image</p>
<h3 id="cÃ i-Ä‘áº·t-2"><a class="header" href="#cÃ i-Ä‘áº·t-2"><strong>CÃ i Ä‘áº·t</strong></a></h3>
<p>ChÃºng ta sá»­ dá»¥ng Maven giá»‘ng bÃ i trÆ°á»›c, tuy nhiÃªn cÃ³ update thÃªm thÆ° viá»‡nÂ <code>io.jsonwebtoken.jwtt</code>Â Ä‘á»ƒ giÃºp chÃºng ta mÃ£ hÃ³a thÃ´ng tin thÃ nhÂ <code>jwt</code></p>
<p><em>pom.xml</em></p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;groupId&gt;org.springframework&lt;/groupId&gt;
    &lt;artifactId&gt;spring-security-jwt&lt;/artifactId&gt;
    &lt;version&gt;0.1.0&lt;/version&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.0.5.RELEASE&lt;/version&gt;
    &lt;/parent&gt;

    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.h2database&lt;/groupId&gt;
            &lt;artifactId&gt;h2&lt;/artifactId&gt;
            &lt;scope&gt;runtime&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;
            &lt;artifactId&gt;jjwt&lt;/artifactId&gt;
            &lt;version&gt;0.9.1&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre>
<p>Cáº¥u trÃºc thÆ° má»¥c code bao gá»“m:</p>
<p>!image</p>
<h3 id="implement-2"><a class="header" href="#implement-2"><strong>Implement</strong></a></h3>
<p>Ban Ä‘áº§u, chÃºng ta sáº½ táº¡o ra classÂ <code>User</code>Â vÃ Â <code>UserDetails</code>Â Ä‘á»ƒ giao tiáº¿p vá»›iÂ <strong>Spring Security</strong>. Pháº§n nÃ y giá»‘ng há»‡t vá»›i bÃ i viáº¿tÂ Spring Security + Hibernate</p>
<p>Trong bÃ i viáº¿t cÃ³ sá»­ dá»¥ngÂ Lombok</p>
<h3 id="táº¡o-user-1"><a class="header" href="#táº¡o-user-1"><strong>Táº¡o User</strong></a></h3>
<p>Táº¡o ra classÂ <code>User</code>Â tham chiáº¿u vá»›i database.</p>
<pre><code>import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.Id;
import javax.persistence.Table;

import lombok.Data;

@Entity
@Table(name = &quot;user&quot;)
@Data // lombok
public class User {
    @Id
    @GeneratedValue
    private Long id;

    @Column(nullable = false, unique = true)
    private String username;
    private String password;
}
</code></pre>
<p>Táº¡oÂ <code>UserRepository</code>Â káº¿ thá»«aÂ <code>JpaRepository</code>Â Ä‘á»ƒ truy xuáº¥t thÃ´ng tin tá»« database.</p>
<pre><code>import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository&lt;User, Long&gt; {
    User findByUsername(String username);
}
</code></pre>
<h3 id="tham-chiáº¿u-user-vá»›i-userdetails-1"><a class="header" href="#tham-chiáº¿u-user-vá»›i-userdetails-1"><strong>Tham chiáº¿u User vá»›i UserDetails</strong></a></h3>
<p>Máº·c Ä‘á»‹nhÂ <strong>Spring Security</strong>Â sá»­ dá»¥ng má»™t Ä‘á»‘i tÆ°á»£ngÂ <code>UserDetails</code>Â Ä‘á»ƒ chá»©a toÃ n bá»™ thÃ´ng tin vá» ngÆ°á»i dÃ¹ng. VÃ¬ váº­y, chÃºng ta cáº§n táº¡o ra má»™t class má»›i giÃºp chuyá»ƒn cÃ¡c thÃ´ng tin cá»§aÂ <code>User</code>Â thÃ nhÂ <code>UserDetails</code></p>
<p><em>CustomUserDetails.java</em></p>
<pre><code>import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import lombok.AllArgsConstructor;
import lombok.Data;

@Data
@AllArgsConstructor
public class CustomUserDetails implements UserDetails {
    User user;

    @Override
    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {
        // Máº·c Ä‘á»‹nh mÃ¬nh sáº½ Ä‘á»ƒ táº¥t cáº£ lÃ  ROLE_USER. Äá»ƒ demo cho Ä‘Æ¡n giáº£n.
        return Collections.singleton(new SimpleGrantedAuthority(&quot;ROLE_USER&quot;));
    }

    @Override
    public String getPassword() {
        return user.getPassword();
    }

    @Override
    public String getUsername() {
        return user.getUsername();
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}
</code></pre>
<p>Khi ngÆ°á»i dÃ¹ng Ä‘Äƒng nháº­p thÃ¬Â <strong>Spring Security</strong>Â sáº½ cáº§n láº¥y cÃ¡c thÃ´ng tinÂ <code>UserDetails</code>Â hiá»‡n cÃ³ Ä‘á»ƒ kiá»ƒm tra. VÃ¬ váº­y, báº¡n cáº§n táº¡o ra má»™t class káº¿ thá»«a lá»›pÂ <code>UserDetailsService</code>Â mÃ Â <strong>Spring Security</strong>Â cung cáº¥p Ä‘á»ƒ lÃ m nhiá»‡m vá»¥ nÃ y.</p>
<p><em>UserService.java</em></p>
<pre><code>import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

@Service
public class UserService implements UserDetailsService {

    @Autowired
    private UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) {
        // Kiá»ƒm tra xem user cÃ³ tá»“n táº¡i trong database khÃ´ng?
        User user = userRepository.findByUsername(username);
        if (user == null) {
            throw new UsernameNotFoundException(username);
        }
        return new CustomUserDetails(user);
    }

}
</code></pre>
<h3 id="jwt"><a class="header" href="#jwt"><strong>JWT</strong></a></h3>
<p>Sau khi cÃ³ cÃ¡c thÃ´ng tin vá» ngÆ°á»i dÃ¹ng, chÃºng ta cáº§n mÃ£ hÃ³a thÃ´ng tin ngÆ°á»i dÃ¹ng thÃ nh chuá»—iÂ <code>JWT</code>. TÃ´i sáº½ táº¡o ra má»™t classÂ <code>JwtTokenProvider</code>Â Ä‘á»ƒ lÃ m nhiá»‡m vá»¥ nÃ y.</p>
<pre><code>import org.springframework.stereotype.Component;
import io.jsonwebtoken.*;
import lombok.extern.slf4j.Slf4j;
import me.loda.springsecurityhibernatejwt.user.CustomUserDetails;

@Component
@Slf4j
public class JwtTokenProvider {
    // Äoáº¡n JWT_SECRET nÃ y lÃ  bÃ­ máº­t, chá»‰ cÃ³ phÃ­a server biáº¿t
    private final String JWT_SECRET = &quot;lodaaaaaa&quot;;

    //Thá»i gian cÃ³ hiá»‡u lá»±c cá»§a chuá»—i jwt
    private final long JWT_EXPIRATION = 604800000L;

    // Táº¡o ra jwt tá»« thÃ´ng tin user
    public String generateToken(CustomUserDetails userDetails) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + JWT_EXPIRATION);
        // Táº¡o chuá»—i json web token tá»« id cá»§a user.
        return Jwts.builder()
                   .setSubject(Long.toString(userDetails.getUser().getId()))
                   .setIssuedAt(now)
                   .setExpiration(expiryDate)
                   .signWith(SignatureAlgorithm.HS512, JWT_SECRET)
                   .compact();
    }

    // Láº¥y thÃ´ng tin user tá»« jwt
    public Long getUserIdFromJWT(String token) {
        Claims claims = Jwts.parser()
                            .setSigningKey(JWT_SECRET)
                            .parseClaimsJws(token)
                            .getBody();

        return Long.parseLong(claims.getSubject());
    }

    public boolean validateToken(String authToken) {
        try {
            Jwts.parser().setSigningKey(JWT_SECRET).parseClaimsJws(authToken);
            return true;
        } catch (MalformedJwtException ex) {
            log.error(&quot;Invalid JWT token&quot;);
        } catch (ExpiredJwtException ex) {
            log.error(&quot;Expired JWT token&quot;);
        } catch (UnsupportedJwtException ex) {
            log.error(&quot;Unsupported JWT token&quot;);
        } catch (IllegalArgumentException ex) {
            log.error(&quot;JWT claims string is empty.&quot;);
        }
        return false;
    }
}
</code></pre>
<h3 id="cáº¥u-hÃ¬nh-vÃ -phÃ¢n-quyá»n-1"><a class="header" href="#cáº¥u-hÃ¬nh-vÃ -phÃ¢n-quyá»n-1"><strong>Cáº¥u hÃ¬nh vÃ  phÃ¢n quyá»n</strong></a></h3>
<p>BÃ¢y giá», chÃºng ta báº¯t Ä‘áº§u cáº¥u hÃ¬nhÂ <strong>Spring Security</strong>Â bao gá»“m viá»‡c kÃ­ch hoáº¡t báº±ngÂ <code>@EnableWebSecurity</code>.</p>
<p>BÆ°á»›c nÃ y giá»‘ng vá»›i bÃ i viáº¿tÂ Spring + HibernateÂ nÃªn tÃ´i sáº½ khÃ´ng nÃ³i nhá»¯ng pháº§n láº·p láº¡i.</p>
<pre><code>import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.BeanIds;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import me.loda.springsecurityhibernatejwt.jwt.JwtAuthenticationFilter;
import me.loda.springsecurityhibernatejwt.user.UserService;

@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    @Autowired
    UserService userService;

    @Bean
    public JwtAuthenticationFilter jwtAuthenticationFilter() {
        return new JwtAuthenticationFilter();
    }

    @Bean(BeanIds.AUTHENTICATION_MANAGER)
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        // Get AuthenticationManager bean
        return super.authenticationManagerBean();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        // Password encoder, Ä‘á»ƒ Spring Security sá»­ dá»¥ng mÃ£ hÃ³a máº­t kháº©u ngÆ°á»i dÃ¹ng
        return new BCryptPasswordEncoder();
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth)
            throws Exception {
        auth.userDetailsService(userService) // Cung cÃ¡p userservice cho spring security
            .passwordEncoder(passwordEncoder()); // cung cáº¥p password encoder
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .cors() // NgÄƒn cháº·n request tá»« má»™t domain khÃ¡c
                    .and()
                .authorizeRequests()
                    .antMatchers(&quot;/api/login&quot;).permitAll() // Cho phÃ©p táº¥t cáº£ má»i ngÆ°á»i truy cáº­p vÃ o Ä‘á»‹a chá»‰ nÃ y
                    .anyRequest().authenticated(); // Táº¥t cáº£ cÃ¡c request khÃ¡c Ä‘á»u cáº§n pháº£i xÃ¡c thá»±c má»›i Ä‘Æ°á»£c truy cáº­p

        // ThÃªm má»™t lá»›p Filter kiá»ƒm tra jwt
        http.addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);
    }
}
</code></pre>
<p>Äiá»ƒm khÃ¡c biá»‡t á»Ÿ Ä‘Ã¢y lÃ  sá»± xuáº¥t hiá»‡n cá»§aÂ <code>JwtAuthenticationFilter</code>. ÄÃ¢y lÃ  má»™t lá»›pÂ <code>Filter</code>Â do tÃ´i tá»± táº¡o ra.</p>
<p><code>JwtAuthenticationFilter</code>Â CÃ³ nhiá»‡m vá»¥ kiá»ƒm tra request cá»§a ngÆ°á»i dÃ¹ng trÆ°á»›c khi nÃ³ tá»›i Ä‘Ã­ch. NÃ³ sáº½ láº¥yÂ <code>Header Authorization</code>Â ra vÃ  kiá»ƒm tra xem chuá»—i JWT ngÆ°á»i dÃ¹ng gá»­i lÃªn cÃ³ há»£p lá»‡ khÃ´ng.</p>
<pre><code>@Slf4j
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    @Autowired
    private JwtTokenProvider tokenProvider;

    @Autowired
    private UserService customUserDetailsService;
    @Override
    protected void doFilterInternal(HttpServletRequest request,
                                    HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {
        try {
            // Láº¥y jwt tá»« request
            String jwt = getJwtFromRequest(request);

            if (StringUtils.hasText(jwt) &amp;&amp; tokenProvider.validateToken(jwt)) {
                // Láº¥y id user tá»« chuá»—i jwt
                Long userId = tokenProvider.getUserIdFromJWT(jwt);
                // Láº¥y thÃ´ng tin ngÆ°á»i dÃ¹ng tá»« id
                UserDetails userDetails = customUserDetailsService.loadUserById(userId);
                if(userDetails != null) {
                    // Náº¿u ngÆ°á»i dÃ¹ng há»£p lá»‡, set thÃ´ng tin cho Seturity Context
                    UsernamePasswordAuthenticationToken
                            authentication = new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());
                    authentication.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                    SecurityContextHolder.getContext().setAuthentication(authentication);
                }
            }
        } catch (Exception ex) {
            log.error(&quot;failed on set user authentication&quot;, ex);
        }

        filterChain.doFilter(request, response);
    }

    private String getJwtFromRequest(HttpServletRequest request) {
        String bearerToken = request.getHeader(&quot;Authorization&quot;);
        // Kiá»ƒm tra xem header Authorization cÃ³ chá»©a thÃ´ng tin jwt khÃ´ng
        if (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(&quot;Bearer &quot;)) {
            return bearerToken.substring(7);
        }
        return null;
    }
}
</code></pre>
<h3 id="táº¡o-controller"><a class="header" href="#táº¡o-controller"><strong>Táº¡o Controller</strong></a></h3>
<p>VÃ¬ pháº§n nÃ y chÃºng ta lÃ m viá»‡c vá»›iÂ <code>JWT</code>, nÃªn cÃ¡c request sáº½ dÆ°á»›i dáº¡ng Rest API.</p>
<p>TÃ´i táº¡o ra 2 api:</p>
<ol>
<li><code>/api/login</code>: Cho phÃ©p request mÃ  khÃ´ng cáº§n xÃ¡c thá»±c.</li>
<li><code>/api/random</code>: LÃ  má»™t api báº¥t ká»³ nÃ o Ä‘Ã³, pháº£i xÃ¡c thá»±c má»›i láº¥y Ä‘Æ°á»£c thÃ´ng tin.</li>
</ol>
<pre><code>@RestController
@RequestMapping(&quot;/api&quot;)
public class LodaRestController {

    @Autowired
    AuthenticationManager authenticationManager;

    @Autowired
    private JwtTokenProvider tokenProvider;

    @PostMapping(&quot;/login&quot;)
    public LoginResponse authenticateUser(@Valid @RequestBody LoginRequest loginRequest) {

        // XÃ¡c thá»±c tá»« username vÃ  password.
        Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(
                        loginRequest.getUsername(),
                        loginRequest.getPassword()
                )
        );

        // Náº¿u khÃ´ng xáº£y ra exception tá»©c lÃ  thÃ´ng tin há»£p lá»‡
        // Set thÃ´ng tin authentication vÃ o Security Context
        SecurityContextHolder.getContext().setAuthentication(authentication);

        // Tráº£ vá» jwt cho ngÆ°á»i dÃ¹ng.
        String jwt = tokenProvider.generateToken((CustomUserDetails) authentication.getPrincipal());
        return new LoginResponse(jwt);
    }

    // Api /api/random yÃªu cáº§u pháº£i xÃ¡c thá»±c má»›i cÃ³ thá»ƒ request
    @GetMapping(&quot;/random&quot;)
    public RandomStuff randomStuff(){
        return new RandomStuff(&quot;JWT Há»£p lá»‡ má»›i cÃ³ thá»ƒ tháº¥y Ä‘Æ°á»£c message nÃ y&quot;);
    }

}
</code></pre>
<h3 id="táº¡o-thÃ´ng-tin-user-trong-database-1"><a class="header" href="#táº¡o-thÃ´ng-tin-user-trong-database-1"><strong>Táº¡o thÃ´ng tin User trong database</strong></a></h3>
<p>TrÆ°á»›c háº¿t báº¡n cáº§n cáº¥u hÃ¬nh cho hibernate káº¿t tá»›i tá»›i h2 database trong fileÂ <code>resources/appication.properties</code></p>
<pre><code>spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
# Enabling H2 Console
spring.h2.console.enabled=true
</code></pre>
<p>Äá»ƒ phá»¥c vá»¥ demo, má»—i khi cháº¡y chÆ°Æ¡ng trÃ¬nh, chÃºng ta cáº§n insert má»™tÂ <code>User</code>Â vÃ o database.</p>
<p>CÃ³ thá»ƒ lÃ m viá»‡c nÃ y báº±ng cÃ¡ch sá»­ dá»¥ngÂ <code>CommandLineRunner</code>. Má»™t interface cá»§a Spring cung cáº¥p, cÃ³ tÃ¡c dá»¥ng thá»±c hiá»‡n má»™t nhiá»‡m vá»¥ khi Spring khá»Ÿi cháº¡y láº§n Ä‘áº§u.</p>
<pre><code>@SpringBootApplication
public class App implements CommandLineRunner {
    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }

    @Autowired
    UserRepository userRepository;
    @Autowired
    PasswordEncoder passwordEncoder;

    @Override
    public void run(String... args) throws Exception {
        // Khi chÆ°Æ¡ng trÃ¬nh cháº¡y
        // Insert vÃ o csdl má»™t user.
        User user = new User();
        user.setUsername(&quot;loda&quot;);
        user.setPassword(passwordEncoder.encode(&quot;loda&quot;));
        userRepository.save(user);
        System.out.println(user);
    }
}
</code></pre>
<h3 id="cháº¡y-thá»­-2"><a class="header" href="#cháº¡y-thá»­-2"><strong>Cháº¡y thá»­</strong></a></h3>
<p>Khi server on, chÃºng ta request thá»­ tá»›i Ä‘á»‹a chá»‰Â <code>http://localhost:8080/api/random</code>Â mÃ  khÃ´ng xÃ¡c thá»±c.</p>
<p>!image</p>
<p>Káº¿t quáº£ tráº£ vá» mÃ£ lá»—iÂ <code>403</code>Â kÃ¨m theo messageÂ <code>Access Denied</code>.</p>
<p>Äá»ƒ cÃ³ thá»ƒ request Ä‘Æ°á»£c, chÃºng ta Ä‘Äƒng nháº­p vÃ o há»‡ thá»‘ng báº±ngÂ <code>api/login</code>Â Ä‘á»ƒ láº¥yÂ <code>jwt</code>.</p>
<p>!image</p>
<p>Sau Ä‘Ã³ sá»­ dá»¥ng thÃ´ng tinÂ <code>jwt</code>Â server tráº£ vá» Ä‘á»ƒ thá»±c hiá»‡n cÃ¡c request khÃ¡c.</p>
<p>!image</p>
<h3 id="káº¿t-2"><a class="header" href="#káº¿t-2"><strong>Káº¿t</strong></a></h3>
<p>Trong bÃ i nÃ y, chÃºng ta Ä‘Ã£ tÃ¬m hiá»ƒu cÃ¡ch sá»­ dá»¥ngÂ <strong>Spring Security</strong>Â vÃ Â <strong>JWT</strong>Â Ä‘á»ƒ cÃ³ thá»ƒ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng trong cÃ¡c há»‡ thá»‘ng Restful API. ChÃºng ta sáº½ tÃ¬m hiá»ƒu cÃ¡c cÃ¡ch xÃ¡c thá»±cÂ <code>OAuth 2.0</code>Â á»Ÿ cÃ¡c bÃ i sau.</p>
<p>ğŸ’Â Náº¿u cÃ³, toÃ n bá»™ project / code máº«u Ä‘Æ°á»£c lÆ°u trá»¯ táº¡i <strong>GitHub</strong></p>
<p>ğŸŒŸÂ ÄÃ¢y lÃ  má»™t bÃ i viáº¿t trongÂ Series <strong>LÃ m chá»§ Spring Boot â€“ Zero to Hero</strong></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../spring-boot/jpa.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../spring-boot/redis.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../spring-boot/jpa.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../spring-boot/redis.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
